name: Yarn Dependency Update

on:
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        type: choice
        options:
          - security-updates
          - common-packages
          - patch-minor
          - all-latest-with-build
        default: 'security-updates'
  schedule:
    # Run weekly on Monday at 10:00 AM UTC
    - cron: '0 10 * * 1'

permissions:
  contents: write
  pull-requests: write

# Note: This workflow requires a Personal Access Token (PAT) to create pull requests.
# The default GITHUB_TOKEN has restricted permissions and cannot create PRs that trigger other workflows.
# 
# To configure the required secret:
# 1. Create a Personal Access Token (classic) with 'repo' and 'workflow' scopes
#    at https://github.com/settings/tokens
# 2. Add the token as a repository secret named 'PAT_TOKEN'
#    at https://github.com/OWNER/REPO/settings/secrets/actions
#
# See: https://github.com/peter-evans/create-pull-request#action-inputs

jobs:
  update-yarn-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Setup PHP with Composer
        uses: ./.github/actions/setup-php-composer
        with:
          php-version: '8.2'
          php-extensions: 'mbstring, xml, ctype, json, fileinfo, pdo, sqlite, mysql'

      - name: Check for package-lock.json conflicts
        id: lockfile-check
        run: |
          echo "========================================="
          echo "Checking for lock file conflicts..."
          echo "========================================="
          
          if [ -f "package-lock.json" ]; then
            echo "⚠️  WARNING: package-lock.json detected!"
            echo "⚠️  This project uses Yarn (yarn.lock), not npm (package-lock.json)"
            echo "⚠️  Having both lock files can cause dependency conflicts"
            echo ""
            echo "lockfile_conflict=true" >> $GITHUB_OUTPUT
            
            # Show when it was last modified
            echo "package-lock.json last modified: $(stat -c %y package-lock.json 2>/dev/null || stat -f '%Sm' package-lock.json 2>/dev/null || echo 'unknown')"
            echo ""
          else
            echo "✓ No package-lock.json conflict detected"
            echo "lockfile_conflict=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "yarn.lock" ]; then
            echo "✓ yarn.lock present (correct for this project)"
          else
            echo "ERROR: yarn.lock is missing!"
            exit 1
          fi
          echo "========================================="

      - name: Install Yarn dependencies
        run: yarn install --frozen-lockfile

      - name: Run Yarn audit
        id: audit
        continue-on-error: true
        run: |
          yarn audit --json > audit-report.json || true
          if [ -s audit-report.json ]; then
            VULNERABILITIES=$(grep -c "auditAdvisory" audit-report.json || echo "0")
            if [ "$VULNERABILITIES" -gt 0 ]; then
              echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
              echo "vulnerability_count=$VULNERABILITIES" >> $GITHUB_OUTPUT
            else
              echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Yarn dependencies (Security Updates Only)
        if: github.event.inputs.update_type == 'security-updates' || github.event_name == 'schedule'
        run: |
          echo "========================================="
          echo "Applying security updates only..."
          echo "========================================="
          
          # Run yarn audit and apply fixes
          yarn audit --json > audit-before.json || true
          
          # Note: Yarn v1 doesn't have 'audit fix', so we identify and upgrade vulnerable packages
          if [ -f audit-report.json ]; then
            echo "Audit report generated. Checking for fixable vulnerabilities..."
            
            # Extract vulnerable package names and upgrade them
            VULNERABLE_PACKAGES=$(grep -o '"module_name":"[^"]*"' audit-report.json | cut -d'"' -f4 | sort -u || echo "")
            
            if [ -n "$VULNERABLE_PACKAGES" ]; then
              echo "Upgrading packages with security vulnerabilities:"
              echo "$VULNERABLE_PACKAGES"
              for pkg in $VULNERABLE_PACKAGES; do
                echo "  Upgrading $pkg..."
                yarn upgrade "$pkg" --latest || true
              done
            else
              echo "✓ No vulnerable packages found to upgrade"
            fi
          else
            echo "⚠️  No audit report available"
          fi
          
          echo "========================================="

      - name: Update Yarn dependencies (Common Packages)
        if: github.event.inputs.update_type == 'common-packages'
        run: |
          echo "========================================="
          echo "Upgrading common packages..."
          echo "========================================="
          # Note: This upgrades a predefined set of commonly updated packages
          yarn upgrade --pattern 'vite|laravel-vite-plugin|tailwindcss|autoprefixer|axios'
          echo "========================================="

      - name: Update Yarn dependencies (Patch & Minor)
        if: github.event.inputs.update_type == 'patch-minor'
        run: |
          echo "========================================="
          echo "Upgrading to latest patch and minor versions..."
          echo "========================================="
          yarn upgrade
          echo "========================================="

      - name: Update Yarn dependencies (All Latest with Build)
        if: github.event.inputs.update_type == 'all-latest-with-build'
        run: |
          echo "========================================="
          echo "Upgrading all packages to latest versions..."
          echo "========================================="
          yarn upgrade --latest
          echo "========================================="

      - name: Build assets
        id: build-assets
        continue-on-error: true
        run: |
          echo "========================================="
          echo "Building production assets..."
          echo "========================================="
          
          # Check if vendor directory exists
          if [ ! -d "vendor" ]; then
            echo "⚠️  WARNING: vendor directory not found!"
            echo "⚠️  Composer dependencies may be missing"
            echo "⚠️  Build may fail, but we will continue to commit yarn.lock"
          fi
          
          # Try to build assets (wrapped in conditional to handle errors)
          if yarn build; then
            echo "Build completed successfully"
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "Build failed, but continuing to commit yarn.lock changes"
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi
          
          echo "========================================="

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet yarn.lock package.json; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Get updated packages
        if: steps.check-changes.outputs.changes_detected == 'true'
        id: updated-packages
        run: |
          # Generate readable package update report
          node .github/scripts/generate-package-update-report.cjs
          echo "UPDATED_PACKAGES<<EOF" >> $GITHUB_OUTPUT
          cat updated-packages.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore(deps): update Yarn dependencies (${{ github.event.inputs.update_type || 'security-updates' }})"
          branch: automated/yarn-update-${{ github.run_number }}
          delete-branch: false
          title: "chore(deps): Update Yarn dependencies (${{ github.event.inputs.update_type || 'security-updates' }})"
          body: |
            ## Yarn Dependency Update
            
            This PR updates Yarn (npm) dependencies.
            
            **Update Type:** ${{ github.event.inputs.update_type || 'security-updates' }}
            **Triggered by:** ${{ github.event_name }}
            
            ### Lock File Status
            
            ${{ steps.lockfile-check.outputs.lockfile_conflict == 'true' && '⚠️ **WARNING:** package-lock.json detected alongside yarn.lock. This can cause dependency conflicts. Consider removing package-lock.json.' || '✓ No lock file conflicts detected.' }}
            
            ### Updated Packages
            
            ```
            ${{ steps.updated-packages.outputs.UPDATED_PACKAGES }}
            ```
            
            ### Checks Performed
            
            - ${{ steps.build-assets.outputs.build_success == 'true' && '[x]' || '[ ]' }} Assets built successfully
            - [x] Dependencies installed and verified
            - [x] Lock file conflicts checked
            
            ${{ steps.build-assets.outputs.build_success == 'false' && '⚠️ **Note:** Assets build failed. This may be due to missing vendor dependencies. Please review and rebuild manually if needed.' || '' }}
            
            ### Security Audit
            
            ${{ steps.audit.outputs.vulnerabilities_found == 'true' && format('{0} security vulnerabilities detected. Please review audit-report.json.', steps.audit.outputs.vulnerability_count) || 'No security vulnerabilities detected.' }}
            
            ### Review Checklist
            
            - [ ] Review updated packages and their changelogs
            - [ ] Verify assets build correctly
            - [ ] Check for breaking changes in frontend
            - [ ] Test UI changes in development environment
            - [ ] Verify no console errors in browser
            ${{ steps.lockfile-check.outputs.lockfile_conflict == 'true' && '- [ ] Remove package-lock.json if not needed' || '' }}
            
            ---
            
            *This PR was automatically created by the Yarn Update workflow.*
          labels: |
            dependencies
            yarn
            automated-pr

      - name: No changes detected
        if: steps.check-changes.outputs.changes_detected == 'false'
        run: echo "No Yarn dependency updates available."
